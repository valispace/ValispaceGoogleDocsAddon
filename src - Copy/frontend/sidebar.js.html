<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
  /**
   * On document load, assign click handlers to each button and try to load the
   * user's origin and destination language preferences if previously set.
   */
  $(function () {
    $('#valispace-connect').click(connectValispaceScript);
    $('#valispace-disconnect').click(disconnectValispaceScript);
    $('#valispace-options').click(OptionsScript);

    // $('#update-all-valis').click(updateAllValisScript);
    // $('#update-all-requirements').click(updateAllRequirementsScript);

    // Updates List of Workspaces when Refresh button is pressed
    $('#update-workspaces').click(updateWorkspacesOptionsScript);
    // Updates List of Projects when Refresh button is pressed
    $('#update-projects').click(updateProjectOptionsScript);


    // $('#update-tree').click(updateSelectedProjectScript);

    // Function Triggered when A workspace is selected
    $('#options-workspaces').change(updateSelectedWorkspaceScript);

    // Function Triggered when A Project is selected
    $('#options-projects').change(updateSelectedProjectScript);
    // $('#connectionStatus').html("Not Connected");

  });



  // TODO Check Connection Status automatically
  function updateConnectedStatusMessage() {
    google.script.run
      .withSuccessHandler(function (connected) {
        if (connected) {
          $('#connectionStatus').html("Connected");
          updateWorkspacesOptionsScript();
          //updateProjectOptionsScript();
        } else {
          $('#connectionStatus').html("Not connected");
        }

      }
      )
      .withFailureHandler(function (error) {
        alert(error);
      }
      )
      .checkValispaceConnexion();
  }

  function updateWorkspacesOptionsScript() {
    google.script.run
      .withSuccessHandler(function (options) {
        var insertedHTML = '<option value = "">Select your Workspace</option>';
        var i;
        for (i = 0; i < options.length; i++) {
          insertedHTML += "<option "
          insertedHTML += 'value="' + options[i].id + '">';
          insertedHTML += options[i].name;
          insertedHTML += "</option>"
        }
        $('#options-workspaces').html(insertedHTML);
      })
      .get_workspaces();
  }

  function updateProjectOptionsScript(workspaceID) {
    google.script.run
      .withSuccessHandler(function (options) {
        var insertedHTML = '<option value = "">Select your Project</option>';
        var i;
        for (i = 0; i < options.length; i++) {
          insertedHTML += "<option "
          insertedHTML += 'value="' + options[i].id + '">';
          insertedHTML += options[i].name;
          insertedHTML += "</option>"
        }
        $('#options-projects').html(insertedHTML);
      })
      .get_projects(workspaceID);
  }

  function updateSelectedWorkspaceScript() {
    var workspaceID = $("#options-workspaces").val();
    var name = $("#options-workspaces option:selected").text();
    updateProjectOptionsScript(workspaceID);
  }

  function updateSelectedProjectScript() {
    var projectId = $("#options-projects").val();
    var projectName = $("#options-projects option:selected").text();
    //updateAllTrees(projectId, projectName);
    google.script.run.build_requirements_tree(projectId);
  }

  function insertNewValiScript() {
    google.script.run
      .withUserObject(this)
      .insertVali();
  }

  function updateAllRequirementsScript() {
    $('#updating-requirements-status').html("Updating...");
    google.script.run
      .withUserObject(this)
      .withSuccessHandler(
        function () {
          $('#updating-requirements-status').html("");
        }
      )
      .withFailureHandler(logError)
      .updateAllRequirements();
  }

  function updateAllValisScript() {
    $('#updating-valis-status').html("Updating...");
    google.script.run
      .withUserObject(this)
      .withSuccessHandler(
        function () {
          $('#updating-valis-status').html("");
        }
      )
      .withFailureHandler(logError)
      .updateValis();
  }

  function logError(error) {
    Logger.log(error)
  }

  function connectValispaceScript() {
    google.script.run
      .withUserObject(this)
      .withSuccessHandler(
        function (res) {
          if (res) {
            $('#connectionStatus').html("Connected");
            updateWorkspacesOptionsScript();
          } else {
            $('#connectionStatus').html("Not connected");
          }
        }
      )
      .withFailureHandler(errorMessage)
      .connectValispace();

  }



  function disconnectValispaceScript() {

  }

  function errorMessage(error) {
    console.log(error);
  }

  function OptionsScript() {
    google.script.run.withUserObject(this).openOptionDialog();
    google.script.run
      .withUserObject(this)
      .withSuccessHandler()
      .withFailureHandler(errorMessage)
      .openOptionDialog();
  }


  function showError(msg, element) {
    var div = $('<div id="error" class="error">' + msg + '</div>');
    $(element).after(div);
  }
</script>