<script src="https://mozilla.github.io/nunjucks/files/nunjucks.min.js"></script>
<script>

function parseData(){
  var specifications = JSON.parse(document.getElementById(types.specifications.data).getAttribute('data'));
  var labels = JSON.parse(document.getElementById(types.labels.data).getAttribute('data'));
  var requirements = JSON.parse(document.getElementById(types.requirements.data).getAttribute('data'));
  var groups = JSON.parse(document.getElementById(types.groups.data).getAttribute('data'));
  var states = JSON.parse(document.getElementById(types.states.data).getAttribute('data'));
  var tags = JSON.parse(document.getElementById(types.tags.data).getAttribute('data'));
  var files = JSON.parse(document.getElementById(types.files.data).getAttribute('data'));
  var users = JSON.parse(document.getElementById(types.users.data).getAttribute('data'));

  return {
			'specifications': specifications,
			'labels': labels,
			'requirements': requirements,
			'groups': groups,
			'states': states,
			'tags': tags,
			'files': files,
			'users': users
		}
}

function genFromTemplate(){
  all_data = parseData()
  google.script.run.withSuccessHandler(html => {
    console.log(html);
    var rendered_html = nunjucks.renderString(html, all_data)
    google.script.run.withFailureHandler(
      download('rendered.html', rendered_html)
    ).withSuccessHandler(id => {
      window.open("https://docs.google.com/document/d/" + id + '/edit');
    }).saveConvertHtmlDrive(
      rendered_html
    )
  }
  ).getGoogleDocumentAsHTML();


}

function download(filename, text) {
    var element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    element.setAttribute('download', filename);

    element.style.display = 'none';
    document.body.appendChild(element);

    element.click();

    document.body.removeChild(element);
}


</script>