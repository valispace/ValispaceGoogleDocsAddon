<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
  /**
   * On document load, assign click handlers to each button and try to load the
   * user's origin and destination language preferences if previously set.
   */
  $(function () {
    updateWorkspacesOptionsScript()
    // getPreviousWorkspace()

    // Updates List of Workspaces when Refresh button is pressed
    $('#update-workspaces').click(updateWorkspacesOptionsScript);
    // Updates List of Projects when Refresh button is pressed
    $('#update-projects').click(updateProjectOptionsScript);

    // Function Triggered when A workspace is selected
    $('#options-workspaces').change(updateSelectedWorkspaceScript);

    // Function Triggered when A Project is selected
    $('#options-projects').change(updateSelectedProjectScript);

    $('#valispace-disconnect').click(disconnectValispaceScript);
    $('#valispace-options').click(OptionsScript);

  });


  function updateWorkspacesOptionsScript() {
    document.getElementById("updating-status").innerHTML = 'Getting Workspaces'
    google.script.run
      .withSuccessHandler(function (options) {
        var insertedHTML = '<option value = "">Select your Workspace</option>';
        var i;
        for (i = 0; i < options.length; i++) {
          insertedHTML += "<option "
          insertedHTML += 'value="' + options[i].id + '">';
          insertedHTML += options[i].name;
          insertedHTML += "</option>"
        }
        $('#options-workspaces').html(insertedHTML);
        document.getElementById("updating-status").innerHTML = ''
      })
      .get_workspaces();

  }

  function updateProjectOptionsScript() {
    var workspaceID = $("#options-workspaces").val();
    document.getElementById("updating-status").innerHTML = 'Updating Project List'
    google.script.run
      .withSuccessHandler(function (options) {
        var insertedHTML = '<option value = "">Select your Project</option>';
        var i;
        for (i = 0; i < options.length; i++) {
          insertedHTML += "<option "
          insertedHTML += 'value="' + options[i].id + '">';
          insertedHTML += options[i].name;
          insertedHTML += "</option>"
        }
        $('#options-projects').html(insertedHTML);
        document.getElementById("updating-status").innerHTML = ''
      })
      .get_projects(workspaceID);
  }

  function updateSelectedWorkspaceScript() {
    var workspaceID = $("#options-workspaces").val();
    var name = $("#options-workspaces option:selected").text();
    updateProjectOptionsScript();
  }


  function updateSelectedProjectScript() {
    clearData()
    // Disable View Requirements Tree Button and Closes DropDown Div
    $('#viewRequirementsTree').off()
    document.getElementById("myDropdown").classList.remove("show");

    document.getElementById("updating-status").innerHTML = 'Downloading Data...'

    clearTreeHtml();
    var projectId = $("#options-projects").val();

    google.script.run.set_project(projectId)
    var projectName = $("#options-projects option:selected").text();


    // Save All Data in the HTML
    console.log('Saving Project Data...')
    saveData(projectId, 'labelsData') // Folders
    saveData(projectId, 'specificationsData')
    saveData(projectId, 'requirementsData')
    saveData(projectId, 'groupsData') // Sections
    saveData(projectId, 'statesData') // Sections
    saveData(projectId, 'tagsData')
    saveData(projectId, 'filesData')
    saveData(projectId, 'usersData')
    saveData(projectId, 'user_groupsData', 1)
    // IMPORTANT: Last Save data must have a flag 1

    console.log('Done Saving Project Data')
  }

  function saveData(projectId, dataType, lastSaveData = 0) {
    google.script.run.withSuccessHandler(
      function (data) {
        // console.log(projectId)
        document.getElementById(dataType).setAttribute('data', JSON.stringify(data));
        if (lastSaveData) {
          document.getElementById("updating-status").innerHTML = '';
          $('#viewRequirementsTree').click(expandRequirementTree);
        }
      }
    ).get_data(projectId, dataType)
  }

  function clearData() {
    document.getElementById('labelsData').removeAttribute('data')
    document.getElementById('specificationsData').removeAttribute('data')
    document.getElementById('requirementsData').removeAttribute('data')
    document.getElementById('groupsData').removeAttribute('data')
    document.getElementById('tagsData').removeAttribute('data')
    document.getElementById('filesData').removeAttribute('data')
  }

  function clearTreeHtml() {
    document.getElementById('requirementTreeInsertButton').innerHTML = '';
  }

  function goToLoginPage() {
    google.script.run
      .withUserObject(this)
      .withSuccessHandler()
      .withFailureHandler(errorMessage).goToMainPage()
  };

  function disconnectValispaceScript() {
    google.script.run.disconnect();
  };

  function errorMessage(error) {
    console.log(error);
  };

  function OptionsScript() {
    google.script.run.withUserObject(this).openOptionDialog();
    google.script.run
      .withUserObject(this)
      .withSuccessHandler()
      .withFailureHandler(errorMessage)
      .openOptionDialog();
  }
</script>