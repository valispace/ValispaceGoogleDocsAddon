<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
	$(function () {
		$('#search-specific-requirement').click(searchSpecificRequirement);
		$('#update-all').click(() => google.script.run.update_all_values());
	});


	function searchSpecificRequirement() {
		google.script.run.openSearchRequirementDialog()
	}


	/* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
	function expandRequirementTree() {
		document.getElementById("myDropdown").classList.toggle("show");
	}

	function expandObjectProperties(objectId) {
		document.getElementById(objectId).classList.toggle("show");
		// addPropertyListener()
	}

	// Rename and Repurpose
	// IN this function the real Requirement Tree will be called and html generated
	function replaceRequirementsTreeHtml() {
		google.script.run.withSuccessHandler(function (htmlToWrite) {
			document.getElementById('requirementTreeInsertButton').innerHTML = htmlToWrite;
			addTreeListener()
		}).buildRequirementTreeHtml();
	}

	function filterFunction() {
		var input, filter, ul, li, a, i;
		input = document.getElementById("myInput");
		filter = input.value.toUpperCase();
		div = document.getElementsByClassName('reqSearcheableObj');
		for (i = 0; i < div.length; i++) {
			txtValue = div[i].textContent || div[i].innerText;
			if (txtValue.toUpperCase().indexOf(filter) > -1) {
				div[i].style.display = "";
			} else {
				div[i].style.display = "none";
			}
		}
	}

	// TODO: The listeners should be for the div, not for the LI
	// Once I separate the div and the Icont, they need to ahve different listeners, sicne they will have different actions
	
	function addTreeListener() {
		// var toggler = document.getElementsByClassName("caret");
		// var i;
		// for (i = 0; i < toggler.length; i++) {
		// 	toggler[i].addEventListener("click", function () {
		// 		this.parentElement.querySelector(".nested").classList.toggle("active");
		// 		this.classList.toggle("caret-down");

		// 	});
		// }

		// var valis = document.getElementsByClassName("vali");
		// for (i = 0; i < valis.length; i++) {
		// 	valis[i].addEventListener("click", function () {
		// 		google.script.run
		// 			.withFailureHandler(errorMessage)
		// 			.insertVali(this.id);
		// 	});
		// }

		var labels = document.getElementsByClassName("label");
		for (i = 0; i < labels.length; i++) {
			labels[i].addEventListener("click", function () {
				labelId = this.id;
				google.script.run.withFailureHandler(errorMessage).direct_insert(labelId, 'name');
			});
		}

		var specifications = document.getElementsByClassName("specification");
		for (i = 0; i < specifications.length; i++) {
			specifications[i].addEventListener("click", function () {
				specId = this.id;
				google.script.run.withFailureHandler(errorMessage).direct_insert(specId, 'name');
			});
		}

		var groups = document.getElementsByClassName("group");
		for (i = 0; i < groups.length; i++) {
			groups[i].addEventListener("click", function () {
				groupId = this.id;
				google.script.run.withFailureHandler(errorMessage).direct_insert(groupId, 'name');
			});
		}

		var requirements = document.getElementsByClassName("requirement");
		for (i = 0; i < requirements.length; i++) {
			requirements[i].addEventListener("click", function () {
				expandObjectProperties(this.id + '_properties')
				// google.script.run.withFailureHandler(errorMessage).direct_insert(this.id, 'text');
				// TODO: Insert Property is fixed to text
			});
		}

		var properties = document.getElementsByClassName("property");
		for (i = 0; i < properties.length; i++) {
			properties[i].addEventListener("click", function () {
				htmlElementId = this.id.split('_property_');
				reqId = htmlElementId[0];
				propertyName = htmlElementId[1];
				google.script.run.withFailureHandler(errorMessage).direct_insert(reqId, propertyName);
			});
		}

		function errorMessage(error) {
			//Logger.log(error);
		}

	}

	function addPropertyListener() {

	}

	function updateTree(id, name) {
		$('#projectTree').html("Loading tree " + name + "....");
		google.script.run.withSuccessHandler(
			function (newHtml) {
				$('#projectTree').html(newHtml);
				addTreeListener();
			}
		)
			.withFailureHandler(
				function (error) {
					$('#projectTree').html("Failed to load project tree. Please try again, if the problem persist contact support@valispace.com");
				})
			.getProjectTree(id);
	}

	//	function updateRequirementTree(id, name){
	//	  $('#requirementTree').html("Loading requirements for " + name + "....");
	//	  google.script.run
	//		.withSuccessHandler(
	//		  function(newHtml){
	//			$('#requirementTree').html(newHtml);
	//			addTreeListener();
	//		  }
	//		)
	//		.withFailureHandler(
	//		  function(error){
	//			$('#requirementTree').html("Failed to load requirement tree. Please try again, if the problem persist contact support@valispace.com");
	//		  }
	//		)
	//		.getRequirementTree(id);
	//	
	//	}

	function updateAllTrees(projectId, projectName) {
		$('#projectTree').html("Loading components for " + name + "....");
		$('#requirementTree').html("Loading requirements for " + name + "....");
		google.script.run
			.withSuccessHandler()
			.withFailureHandler(
				function (error) {
					$('#requirementTree').html("Failed to load requirements. Please try again, if the problem persist contact support@valispace.com");
				})
			.getRequirementTree(projectId);

	}



</script>